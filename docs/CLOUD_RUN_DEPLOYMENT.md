# Cloud Run Deployment

Quick reference for managing the Cloud Run deployment.

**Production URL**: https://measurehero-slack-app-133390045585.europe-west1.run.app  
**GitHub Repo**: https://github.com/prabapro/measurehero-slack-app

## Deployment Method

**Primary**: GitHub auto-deploy (push to `main` branch)  
**Backup**: Manual gcloud commands

---

## GitHub Auto-Deploy (Primary)

### How It Works

1. Push code to `main` branch
2. Cloud Build automatically triggers
3. Builds Docker image using your Dockerfile
4. Deploys to Cloud Run
5. ~2-4 minutes total

### Deploy New Changes

```bash
git add .
git commit -m "Your commit message"
git push origin main
```

That's it! Cloud Build handles the rest.

### Monitor Build Progress

**Option 1: Cloud Console**

```
https://console.cloud.google.com/cloud-build/builds?project=measurehero-slack-app
```

**Option 2: gcloud CLI**

```bash
gcloud builds list --limit 5
gcloud builds log BUILD_ID  # Get BUILD_ID from list command
```

### Build Configuration

Located at root: `cloudbuild.yaml` (auto-generated by Cloud Run)

Build steps:

1. **Build** Docker image from Dockerfile
2. **Push** to Artifact Registry (`cloud-run-source-deploy` repo)
3. **Deploy** to Cloud Run

---

## Manual Deploy (Backup)

Use this if GitHub integration fails or for emergency hotfixes.

### Prerequisites

```bash
# Install gcloud CLI (if not already)
brew install google-cloud-sdk  # macOS

# Login & configure
gcloud auth login
gcloud config set project measurehero-slack-app
gcloud config set run/region europe-west1
```

### Manual Deploy Commands

```bash
# Build & push image
gcloud builds submit --tag europe-west1-docker.pkg.dev/measurehero-slack-app/measurehero-repo/measurehero-slack-app:manual

# Deploy
gcloud run deploy measurehero-slack-app \
  --image europe-west1-docker.pkg.dev/measurehero-slack-app/measurehero-repo/measurehero-slack-app:manual \
  --region europe-west1
```

---

## Common Tasks

### View Logs

```bash
# Recent logs
gcloud run services logs read measurehero-slack-app --region europe-west1 --limit 50

# Live tail
gcloud run services logs tail measurehero-slack-app --region europe-west1

# Build logs
gcloud builds log BUILD_ID
```

### Update Environment Variables

```bash
# Single variable
gcloud run services update measurehero-slack-app \
  --region europe-west1 \
  --update-env-vars KEY=value

# Multiple variables
gcloud run services update measurehero-slack-app \
  --region europe-west1 \
  --update-env-vars KEY1=value1,KEY2=value2

# Remove variable
gcloud run services update measurehero-slack-app \
  --region europe-west1 \
  --remove-env-vars KEY
```

### View Current Config

```bash
# Get service URL
gcloud run services describe measurehero-slack-app \
  --region europe-west1 \
  --format='value(status.url)'

# View env vars
gcloud run services describe measurehero-slack-app \
  --region europe-west1 \
  --format='table(spec.template.spec.containers[0].env[].name, spec.template.spec.containers[0].env[].value)'

# View latest revision
gcloud run revisions list \
  --service measurehero-slack-app \
  --region europe-west1 \
  --limit 1
```

---

## Scaling & Performance

### Adjust Resources

```bash
# Increase memory/CPU
gcloud run services update measurehero-slack-app \
  --region europe-west1 \
  --memory 1Gi \
  --cpu 2

# Set min instances (reduce cold starts)
gcloud run services update measurehero-slack-app \
  --region europe-west1 \
  --min-instances 1

# Increase timeout
gcloud run services update measurehero-slack-app \
  --region europe-west1 \
  --timeout 300
```

### View Metrics

```bash
# Open in browser
open "https://console.cloud.google.com/run/detail/europe-west1/measurehero-slack-app/metrics"
```

---

## Rollback

### List Recent Revisions

```bash
gcloud run revisions list \
  --service measurehero-slack-app \
  --region europe-west1
```

### Rollback to Previous Version

```bash
gcloud run services update-traffic measurehero-slack-app \
  --region europe-west1 \
  --to-revisions REVISION-NAME=100
```

Replace `REVISION-NAME` with revision from list command (e.g., `measurehero-slack-app-00042-abc`).

---

## Troubleshooting

### Build Fails on GitHub Push

**Check build logs**:

```bash
gcloud builds list --limit 5
gcloud builds log BUILD_ID
```

**Common issues**:

- Syntax error in Dockerfile
- Missing dependencies in package.json
- Build timeout (increase in cloudbuild.yaml)

### Service Crashes After Deploy

```bash
# Check logs immediately
gcloud run services logs read measurehero-slack-app --region europe-west1 --limit 100

# Common issues:
# - Missing env vars
# - Invalid GOOGLE_PRIVATE_KEY format
# - Wrong PORT (should be 3000)
```

### GitHub Push Not Triggering Build

1. Check Cloud Build trigger is enabled:
   ```
   https://console.cloud.google.com/cloud-build/triggers?project=measurehero-slack-app
   ```
2. Verify branch is `main` (not `master`)
3. Check GitHub connection status

### Health Check Failed

```bash
curl https://measurehero-slack-app-133390045585.europe-west1.run.app/health

# Should return:
# {"status":"healthy","timestamp":"...","environment":"production"}
```

### Permission Errors

```bash
# Re-authenticate
gcloud auth login
gcloud auth application-default login

# Verify project
gcloud config get-value project
```

---

## GitHub Integration Setup (Reference)

This was done during initial setup. Keep for reference if you need to reconfigure.

### Enable Cloud Build GitHub App

1. Go to [Cloud Build Triggers](https://console.cloud.google.com/cloud-build/triggers)
2. **Connect Repository** → GitHub
3. Authenticate & select repo: `prabapro/measurehero-slack-app`
4. Cloud Run auto-creates trigger on `main` branch

### Trigger Configuration

- **Name**: Auto-generated by Cloud Run
- **Event**: Push to branch `main`
- **Configuration**: `cloudbuild.yaml` (auto-generated)
- **Service**: `measurehero-slack-app`
- **Region**: `europe-west1`

---

## Cost Optimization

Current config scales to zero (`--min-instances 0`) to minimize costs.

**Free tier includes**:

- 2M requests/month
- 360k GB-seconds memory
- 180k vCPU-seconds

**View costs**: [Cloud Billing Console](https://console.cloud.google.com/billing)

---

## Security

✅ HTTPS automatic (SSL certs managed)  
✅ Signature verification in middleware  
✅ Env vars encrypted at rest  
✅ Auto-deploy from protected `main` branch  
❌ Never commit credentials to Git  
❌ `--allow-unauthenticated` required (Slack needs public access)

---

## Monitoring Setup

### Uptime Check

1. Go to [Cloud Monitoring](https://console.cloud.google.com/monitoring)
2. **Uptime Checks → Create Uptime Check**
3. Configure:
   - URL: `https://measurehero-slack-app-133390045585.europe-west1.run.app/health`
   - Check frequency: 1 minute
4. Add alert notifications

### Build Notifications

Set up Slack/email notifications for build failures:

1. Go to [Cloud Build Settings](https://console.cloud.google.com/cloud-build/settings)
2. **Notifications** → Configure
3. Add Slack webhook or email

---

## Deployment Workflow

### Development Workflow

```bash
# 1. Make changes locally
# 2. Test locally
pnpm dev

# 3. Commit & push
git add .
git commit -m "feat: add new feature"
git push origin main

# 4. Monitor build (optional)
gcloud builds list --limit 1

# 5. Verify deployment
curl https://measurehero-slack-app-133390045585.europe-west1.run.app/health

# 6. Check logs if needed
gcloud run services logs tail measurehero-slack-app --region europe-west1
```

### Hotfix Workflow

If you need to bypass CI/CD for emergency fix:

```bash
# Use manual deploy method
gcloud builds submit --tag europe-west1-docker.pkg.dev/measurehero-slack-app/measurehero-repo/measurehero-slack-app:hotfix
gcloud run deploy measurehero-slack-app --image europe-west1-docker.pkg.dev/measurehero-slack-app/measurehero-repo/measurehero-slack-app:hotfix --region europe-west1

# Then sync your Git repo
```

---

## Delete Service (If Needed)

```bash
# Delete service
gcloud run services delete measurehero-slack-app --region europe-west1

# Delete Cloud Build trigger
gcloud builds triggers delete TRIGGER_ID

# Delete container images
gcloud artifacts repositories delete cloud-run-source-deploy --location europe-west1
```

---

## Resources

- [Cloud Run Docs](https://cloud.google.com/run/docs)
- [Cloud Build Docs](https://cloud.google.com/build/docs)
- [GitHub Integration](https://cloud.google.com/build/docs/automating-builds/github/connect-repo-github)
- [gcloud run commands](https://cloud.google.com/sdk/gcloud/reference/run)
- [Pricing](https://cloud.google.com/run/pricing)
